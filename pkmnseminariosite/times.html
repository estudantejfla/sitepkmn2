<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Meus Times</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <a href="index.html">Início</a>
      <a href="times.html">Meus Times</a>
      <a href="criar_time.html">Criar Time</a>
      <a href="publicos.html">Times Públicos</a>
    </div>
    <h1>Meus Times — <span id="usuario"></span></h1>
    <div id="meusTimes"></div>
    <button onclick="window.location.href='criar_time.html'">Criar Novo Time</button>
    <a href="index.html" onclick="logout()">Sair</a>
  </div>
<script src="frontend-api.js"></script>
<script>
const user = JSON.parse(localStorage.getItem("user") || "null");
if (!user) { alert("Você precisa estar logado"); window.location.href="index.html"; }
document.getElementById("usuario").textContent = user.username;
const nameToId = {};
async function ensureNameToId(names){
  const missing = names.filter(n=>!(n in nameToId));
  await Promise.all(missing.map(async n=>{
    try{
      const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${n.toLowerCase()}`);
      if (!r.ok) return;
      const j = await r.json();
      nameToId[n.toLowerCase()] = j.id;
    }catch{}
  }));
}
async function loadTeams(){
  const div = document.getElementById("meusTimes");
  div.innerHTML = "Carregando...";
  const res = await apiFetch(`/teams/user/${user.id}`);
  if (!res.ok) return div.innerHTML = "Erro ao carregar times.";
  const teams = res.data || [];
  if (!teams.length) { div.innerHTML = "Você ainda não criou nenhum time."; return; }
  const allNames = Array.from(new Set(teams.flatMap(t => t.pokemon || [])));
  await ensureNameToId(allNames);
  div.innerHTML = "";
  teams.forEach(t=>{
    const pokeHTML = (t.pokemon || []).map(p=>{
      const id = nameToId[p.toLowerCase()] || 1;
      return `<div class="pokemon-item"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png"><span>${p}</span></div>`;
    }).join("");
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<strong>${t.name}</strong><div class="pokemon-container">${pokeHTML}</div>
      <div class="time-actions">
        <button onclick="editarTime('${t.id}')">Editar</button>
        <button onclick="compartilharTime('${t.id}')">Compartilhar</button>
        <button onclick="excluirTime('${t.id}')">Excluir</button>
      </div>`;
    div.appendChild(card);
  });
}
window.editarTime = id => { window.location.href = `criar_time.html?edit=${id}`; };
window.compartilharTime = async id => {
  const res = await apiFetch(`/teams/share/${id}`, { method: "POST" });
  alert(res.ok ? "Time compartilhado" : (res.data?.error||"Erro"));
  loadTeams();
};
window.excluirTime = async id => {
  if (!confirm("Excluir este time?")) return;
  const res = await apiFetch(`/teams/${id}`, { method: "DELETE" });
  if (res.ok) loadTeams(); else alert(res.data?.error || "Erro ao excluir");
};
window.logout = () => { localStorage.removeItem("token"); localStorage.removeItem("user"); window.location.href="index.html"; };
loadTeams();
</script>
</body>
</html>
