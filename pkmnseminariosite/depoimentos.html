<script src="frontend-api.js"></script>
<script>
(async function(){
  const user = JSON.parse(localStorage.getItem("user")||"null");

  async function load() {
    const res = await apiFetch("/depoimentos");
    const items = res.ok ? (res.data || []) : [];
    const list = document.getElementById('depList');
    list.innerHTML = items.map(t=>`<div class='card'><p>"${t.message}"</p><span class="muted">${t.user?.username||t.userId}</span></div>`).join('');
  }

  document.getElementById('depBtn').addEventListener('click', async ()=>{
    const v = document.getElementById('depInput').value.trim();
    const n = document.getElementById('depNome').value.trim() || (user?.username || "An√¥nimo");
    if(!v) return;
    const payload = user ? { userId: user.id, message: v } : { userId: null, message: v };
    const res = await apiFetch("/depoimentos", { method: "POST", body: JSON.stringify(payload) });
    if (res.ok) {
      document.getElementById('depInput').value = '';
      document.getElementById('depNome').value = '';
      load();
    } else alert(res.data?.error || 'Erro ao enviar depoimento');
  });

  load();
})();
</script>
